#!/bin/bash

set -e
[ -n "${DEBUG}" ] && set -x

# This script is intended to be called by the ci scripts, please dont 
# execute it directly.

## Configuration
#####################################################################

SCRIPT_PATH="$(cd $(dirname "$0")/$(dirname "$(readlink "$0")") && pwd)"

PROJECT_ROOT="$( cd "${SCRIPT_PATH}/../../../" && pwd )"

DCOS_BRANCH=${DCOS_BRANCH:-""}
DCOS_ORIGIN=${DCOS_ORIGIN:-"https://github.com/mesosphere/dcos"}
DCOS_UPSTREAM=${DCOS_UPSTREAM:-"https://github.com/dcos/dcos"}
DCOS_FOLDER=${DCOS_FOLDER:-"dcos-master"}

PKG_VERSION={$PKG_VERSION:-""}
PKG_TARGET={$PKG_TARGET:-""}

## Check Params
#####################################################################

if [ -z "${DCOS_BRANCH}" ] || [ -z "${PKG_TARGET}" ] || [ -z "${PKG_VERSION}" ]; then
  echo "Cant update DC/OS repo without given \$DCOS_BRANCH, \$PKG_TARGET and \$PKG_VERSION!"
  exit 1
fi

## Update DC/OS Repo
#####################################################################

[ -d "${PROJECT_ROOT}/${DCOS_FOLDER}" ] && rm -rf ${PROJECT_ROOT}/${DCOS_FOLDER}

# clone & checkout correct branch
git clone "${DCOS_ORIGIN}" ${PROJECT_ROOT}/${DCOS_FOLDER}

git -C "${PROJECT_ROOT}/${DCOS_FOLDER}" \
  checkout -B ${DCOS_BRANCH}

# rebase onto latest master
git -C "${PROJECT_ROOT}/${DCOS_FOLDER}" \
  remote add upstream "${DCOS_UPSTREAM}"

git -C "${PROJECT_ROOT}/${DCOS_FOLDER}" \
  pull --rebase -X theirs upstream ${PKG_TARGET}

# copy previously created files
if [ -f "buildinfo.json" ]; then
  cp -f ${PROJECT_ROOT}/buildinfo.json ${PROJECT_ROOT}/${DCOS_FOLDER}/packages/dcos-ui/buildinfo.json
fi

if [ -f "upstream.json" ]; then
  cp -f ${PROJECT_ROOT}/upstream.json ${PROJECT_ROOT}/${DCOS_FOLDER}/packages/upstream.json
fi

# push changes (we want to create a new commit for easier checks in Github UI)
git -C "${PROJECT_ROOT}/${DCOS_FOLDER}" \
  add "${PROJECT_ROOT}/${DCOS_FOLDER}/packages/dcos-ui/buildinfo.json" \
    "${PROJECT_ROOT}/${DCOS_FOLDER}/packages/upstream.json"

git -C "${PROJECT_ROOT}/${DCOS_FOLDER}" \
  commit -m "chore(dcos-ui): bump DC/OS UI ${PKG_VERSION}"

git -C "${PROJECT_ROOT}/${DCOS_FOLDER}" \
  push --force-with-lease origin ${DCOS_BRANCH}

# leave & cleanup
rm -rf ${PROJECT_ROOT}/${DCOS_FOLDER}
